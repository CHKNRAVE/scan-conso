<!doctype html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>À propos de Scan Conso</title>
		<style>
			html, body {
				max-width: 100%;
			}
			p, h1, ul, ol, #storageButtons {
				text-align: justify;
				max-width: 90vw;
				margin: 0 auto;
			}
			li {
				max-width: 80vw;
			}
			p {
				margin-block-end: 0.75em;
			}
			h1 {
				margin-block-start: 1.25em;
			}
			#root {
				min-height: unset !important;
			}
			#storageButtons {
				display: flex;
				flex-flow: wrap;
				row-gap: 0.5em;
				justify-content: center;
			}
			#storageButtons button {
				font-size: 1em;
			}
		</style>
		<link rel="icon" href="favicon.svg">
	</head>
	<body>
		<div id="root"></div>
		<script type="module" src="/src/about.jsx"></script>
		<script>
			popUpLocalStorage = function() {
				console.log(localStorage);
				if(Object.keys(localStorage).length) {
					alert(JSON.stringify(localStorage));
				} else {
					alert("L'objet localStorage est actuellement vide. Scannez un premier code-barres, et des premières données seront visibles dans cette alerte.");
				};
			};
			clearLocalStorage = function() {
				const clearConfirmed = confirm("Voulez-vous vraiment vider vos données locales pour Scan Conso ?\nAssurez-vous de les avoir exportées, il s'agit de tous vos codes-barres.");
				if(!clearConfirmed) return;
				localStorage.clear();
				alert("Les données locales ont été effacées.");
			};
			exportLocalStorage = function() {
				const localStorageContents = JSON.stringify(localStorage || {});
				navigator.clipboard.writeText(localStorageContents);
				alert("Vos données locales sont maintenant dans votre presse-papiers (copier-coller).\nCollez-les où le souhaitez, par exemple pour transférer vers un autre navigateur.\nCertains navigateurs peuvent demander votre autorisation avant que la copie soit effectuée.");
			};
			importLocalStorage = function() {
				const pastedContents = prompt("Collez les données à ajouter.");
				if(!pastedContents) return;
				try {
					const pastedObject = JSON.parse(pastedContents);
					console.log("Pasted object", pastedObject);
					for(const key of Object.keys(pastedObject)) {

						const localItem = JSON.parse(localStorage.getItem(key) || "{}");
						console.log("localItem", localItem);

						const pastedItem = JSON.parse(pastedObject[key]) || {};
						console.log("pastedItem", pastedItem);

						const combinedItem = {...localItem, ...pastedItem};
						console.log("combinedItem", combinedItem);

						localStorage.setItem(key, JSON.stringify(combinedItem));
					};
					alert("Importation effectuée. Si un code existant est identique à un que vous avez collé, son surnom est remplacé.");
				} catch (error) {
					alert(`Vous n'avez pas collé des données valides.\nLe format attendu est sous la forne: { }`);
				}
			};
		</script>
		<h1>Le projet</h1>
		<p>Scan Conso est une application basée sur l'API <a href='https://data.economie.gouv.fr/explore/dataset/rappelconso-v2-gtin-espaces/information/'>RappelConso V2</a>, documentée sur le site "open data" du site du ministère français de l'Économie.</p>
		<p>Cette application est développée par une seule personne indépendante. J'ai débuté ce projet dans le but de maîtriser l'outil de développement web React. Bien entendu, comme je ne fais que commencer, l'application peut sûrement être optimisée à de nombreux endroits.</p>
		<p>Les icônes utilisées viennent de <a href="https://fontawesome.com/">Font Awesome</a>, elles sont gratuites et open-source.</p>

		<h1>Responsabilités</h1>
		<p>Cette application web ne peut pas être tenue responsable en cas de donnée non-répertoriée au moment de tout incident. Je ne fais que rendre les informations disponibles plus accessibles.</p>
		<p>La création et la maintenance de cette application sont une initiative personnelle sans lien avec mon activité professionnelle.</p>

		<h1>Vie privée</h1>
		<p>Les recherches de rappels que vous effectuez via cette application sont envoyées directement de votre navigateur à l'API citée plus haut. Renseignez-vous auprès de votre navigateur et du site du ministère de l'Économie, pour savoir ce qu'ils en font par la suite.</p>
		<p>
			Cette application ne stocke pas vos codes dans un serveur. Ils sont conservés dans votre navigateur, sans cookie parce que c'est l'application et non un serveur qui les utilise.<br>
			Quelques avantages :
			<ul>
				<li>Les coûts sont minimisés de mon côté, ce qui me permet de garder cette application en vie plus facilement.</li>
				<li>N'ayant aucune donnée personnelle conservée de mon côté, je ne crains pas d'enfreindre des lois comme le RGPD, et les utilisateurs soucieux de leurs données personnelles sont rassurés.</li>
			</ul>
			Quelques inconvénients :
			<ul>
				<li>Vous ne pouvez pas être notifié.e d'un nouveau rappel en dehors de l'application, il faut vérifier ici de temps en temps.</li>
				<li>Effacer vos données temporaires (en vidant votre historique, votre cache...) risque de tout effacer.</li>
			</ul>
		</p>
		<p>Utilisez les boutons ci-dessous pour transférer vos données.</p>
		<div id="storageButtons">
			<button onclick="clearLocalStorage()">Effacer les données locales</button>
			<button onclick="exportLocalStorage()">Copier les données locales</button>
			<button onclick="importLocalStorage()">Importer des données</button>
		</div>
		<p title="13 octets pour le code, 20 pour le surnom, 6 pour la ponctuation du format JSON = 39 octets par code + surnom.\n5Mo = 5 * 1024ko = 5120 * 1024 octets">Tout est stocké dans <code>localStorage</code>. Les navigateurs lui accordent une taille maximale de 5Mo en moyenne, soit plus de 130000 codes-barres avec des surnoms de 20 caractères chacun.</p>
		<p>Vous pouvez <a href="javascript:popUpLocalStorage()">cliquer ici</a> pour afficher le contenu de <code>localStorage</code> dans une alerte du navigateur, et ainsi voir 100% de ce qui est stocké dans votre navigateur pour ce site.</p>
		<p>L'application est hébergée via CloudFlare, qui ne garde pas de trace de votre activité ici.</p>
		<p>conso.gouv.fr, cependant, enregistre un cookie quand l'API est appelée.</p>
		<p>Le fonctionnement de l'outil React fait que votre navigateur communique avec le site, uniquement afin de savoir quoi afficher, rien n'est conservé pour cette partie non plus.</p>

		<h1>Fonctionnement</h1>
		<p>À l'aide d'un <a href="https://www.npmjs.com/package/barcode-detector">module détecteur de codes-barres</a>, l'image que vous envoyez est lue et le premier code-barres trouvé est identifié.</p>
		<p>Si le code correspond bien à l'image, vous pouvez valider, et il sera sauvegardé localement.</p>
		<p>Le détecteur de codes-barres peut ne pas trouver de code. Dans ce cas, vous pouvez le rentrer manuellement.</p>
		<p>
			De retour sur la page principale, l'API du ministère de l'Économie est consultée avec une demande par code-barres.
			<ul>
				<li>Par exemple, pour le code-barres <code>3770001691053</code>, l'URL demandée est <a href="https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/rappelconso-v2-gtin-espaces/records?where=identification_produits%20LIKE%20%27%253770001691053%25%27">celle-ci</a>.</li>
				<li>Cette adresse envoie une requête SQL <code>WHERE identification_produits LIKE '%3770001691053%'</code>, ou dont le critère est que l'identification du produit contient le code <code>3770001691053</code>. Je me sers de cette même donnée pour le tableau des codes-barres, lots, et dates limites concernés.</li>
			</ul>
		</p>
		<p>En réponse, l'API envoie une liste de résultats (les différents rappels liés au code-barres demandé) qui peut être vide, au format JSON.</p>
		<p>Il ne reste plus qu'à afficher la réponse de manière plus accessible. Les résultats sont triés dans l'ordre :<ol>
			<li>Rappels trouvés</li>
			<li>Erreurs lors de la recherche</li>
			<li>Recherches en cours</li>
			<li>Aucun rappel répertorié</li>
		</ol></p>
		<p>Si un rappel est trouvé, vérifiez les références concernées, et les informations complètes sur Rappel Conso.</p>
	</body>
</html>